FROM node:alpine AS development

ARG BASE_URL
ARG PORT
ARG NEXT_PUBLIC_API_SERVER_URL
ARG NEXT_PUBLIC_API_SERVER_PORT
ARG NEXT_PUBLIC_NODE_ENV
ARG ANALYZE
ARG SESSION_SECRET
ARG PAYPAL_SECRET
ARG NEXT_PUBLIC_PAYPAL_CLIENT_ID_SANDBOX
ARG NEXT_PUBLIC_PAYPAL_CLIENT_ID_PRODUCTION
ARG NEXT_TELEMETRY_DEBUG
ARG NEXT_TELEMETRY_DISABLED

ENV BASE_URL=${BASE_URL}
ENV PORT=${PORT}
ENV NEXT_PUBLIC_API_SERVER_URL=${NEXT_PUBLIC_API_SERVER_URL}
ENV NEXT_PUBLIC_API_SERVER_PORT=${NEXT_PUBLIC_API_SERVER_PORT}
ENV NEXT_PUBLIC_NODE_ENV=${NEXT_PUBLIC_NODE_ENV}
ENV ANALYZE=${ANALYZE}
ENV SESSION_SECRET=${SESSION_SECRET}
ENV PAYPAL_SECRET=${PAYPAL_SECRET}
ENV NEXT_PUBLIC_PAYPAL_CLIENT_ID_SANDBOX=${NEXT_PUBLIC_PAYPAL_CLIENT_ID_SANDBOX}
ENV NEXT_PUBLIC_PAYPAL_CLIENT_ID_PRODUCTION=${NEXT_PUBLIC_PAYPAL_CLIENT_ID_PRODUCTION}
ENV NEXT_TELEMETRY_DEBUG=${NEXT_TELEMETRY_DEBUG}
ENV NEXT_TELEMETRY_DISABLED=${NEXT_TELEMETRY_DISABLED}

RUN mkdir -p /client
WORKDIR /client
COPY ./frontend/package.*json /client
RUN npm install
RUN npx next telemetry disable
COPY ./frontend /client
CMD ["npm", "run", "dev"]

FROM node:alpine AS production

ARG BASE_URL
ARG PORT
ARG NEXT_PUBLIC_API_SERVER_URL
ARG NEXT_PUBLIC_API_SERVER_PORT
ARG NEXT_PUBLIC_NODE_ENV
ARG ANALYZE
ARG SESSION_SECRET
ARG PAYPAL_SECRET
ARG NEXT_PUBLIC_PAYPAL_CLIENT_ID_SANDBOX
ARG NEXT_PUBLIC_PAYPAL_CLIENT_ID_PRODUCTION
ARG NEXT_TELEMETRY_DEBUG
ARG NEXT_TELEMETRY_DISABLED

ENV BASE_URL=${BASE_URL}
ENV PORT=${PORT}
ENV NEXT_PUBLIC_API_SERVER_URL=${NEXT_PUBLIC_API_SERVER_URL}
ENV NEXT_PUBLIC_API_SERVER_PORT=${NEXT_PUBLIC_API_SERVER_PORT}
ENV NEXT_PUBLIC_NODE_ENV=${NEXT_PUBLIC_NODE_ENV}
ENV ANALYZE=${ANALYZE}
ENV SESSION_SECRET=${SESSION_SECRET}
ENV PAYPAL_SECRET=${PAYPAL_SECRET}
ENV NEXT_PUBLIC_PAYPAL_CLIENT_ID_SANDBOX=${NEXT_PUBLIC_PAYPAL_CLIENT_ID_SANDBOX}
ENV NEXT_PUBLIC_PAYPAL_CLIENT_ID_PRODUCTION=${NEXT_PUBLIC_PAYPAL_CLIENT_ID_PRODUCTION}
ENV NEXT_TELEMETRY_DEBUG=${NEXT_TELEMETRY_DEBUG}
ENV NEXT_TELEMETRY_DISABLED=${NEXT_TELEMETRY_DISABLED}

COPY ./frontend /client
WORKDIR /client
RUN npm install
RUN npx next telemetry disable \
    npm run build
CMD ["npm", "run", "start"]
