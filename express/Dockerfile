FROM node:alpine AS development

# Load the arguments which subsitute for environment variables.
# Because RUN instructions do not receive env variables from the environment: instruction in docker compose.
ARG START_FIRST_TIME
ARG NODE_ENV
ARG HOSTNAME
ARG PORT
ARG SESSION_SECRET
ARG NEXTJS_ORIGIN
ARG NEXTJS_PORT
ARG PG_SUPER_USER
ARG PG_SUPER_PASSWORD
ARG PG_ADMIN_USER
ARG PG_ADMIN_PASSWORD
ARG PG_HOST
ARG PG_PORT
ARG PG_SUPER_DATABASE
ARG PG_ADMIN_DATABASE
ARG REDIS_HOST
ARG REDIS_PORT
ARG PAYPAL_SECRET
ARG PAYPAL_CLIENT_ID_SANDBOX
ARG PAYPAL_CLIENT_ID_PRODUCTION
ARG STRIPE_SECRET_KEY

# SERVER CONFIG
ENV START_FIRST_TIME=${START_FIRST_TIME}
ENV NODE_ENV=${NODE_ENV}
ENV HOSTNAME=${HOSTNAME}
ENV PORT=${PORT}
ENV SESSION_SECRET=${SESSION_SECRET}
ENV NEXTJS_ORIGIN=${NEXTJS_ORIGIN}
ENV NEXTJS_PORT=${NEXTJS_PORT}
# PSQL DATABSE CONFIG
ENV PG_SUPER_USER=${PG_SUPER_USER}
ENV PG_SUPER_PASSWORD=${PG_SUPER_PASSWORD}
ENV PG_ADMIN_USER=${PG_ADMIN_USER}
ENV PG_ADMIN_PASSWORD=${PG_ADMIN_PASSWORD}
ENV PG_HOST=${PG_HOST}
ENV PG_PORT=${PG_PORT}
ENV PG_SUPER_DATABASE=${PG_SUPER_DATABASE}
ENV PG_ADMIN_DATABASE=${PG_ADMIN_DATABASE}
# REDIS DATABASE CONFIG
ENV REDIS_HOST=${REDIS_HOST}
ENV REDIS_PORT=${REDIS_PORT}
# PAYMENTS
# Paypal
ENV PAYPAL_SECRET=${PAYPAL_SECRET}
# Paypal client_id for development mode
ENV PAYPAL_CLIENT_ID_SANDBOX=${PAYPAL_CLIENT_ID_SANDBOX}
# Paypal client_id for production mode
ENV PAYPAL_CLIENT_ID_PRODUCTION=${PAYPAL_CLIENT_ID_PRODUCTION}
# Stripe
ENV STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}

COPY . /api-server
WORKDIR /api-server
# Install node modules
RUN npm install
#CMD ["npm", "run", "dev"]
CMD chmod u+x scriptForDocker.sh && sh ./scriptForDocker.sh ${START_FIRST_TIME} ${NODE_ENV}

FROM node:alpine AS production

# Load the arguments which subsitute for environment variables.
# Because RUN instructions do not receive env variables from the environment: instruction in docker compose.
ARG START_FIRST_TIME
ARG NODE_ENV
ARG HOSTNAME
ARG PORT
ARG SESSION_SECRET
ARG NEXTJS_ORIGIN
ARG NEXTJS_PORT
ARG PG_SUPER_USER
ARG PG_SUPER_PASSWORD
ARG PG_ADMIN_USER
ARG PG_ADMIN_PASSWORD
ARG PG_HOST
ARG PG_PORT
ARG PG_SUPER_DATABASE
ARG PG_ADMIN_DATABASE
ARG REDIS_HOST
ARG REDIS_PORT
ARG PAYPAL_SECRET
ARG PAYPAL_CLIENT_ID_SANDBOX
ARG PAYPAL_CLIENT_ID_PRODUCTION
ARG STRIPE_SECRET_KEY

# SERVER CONFIG
ENV START_FIRST_TIME=${START_FIRST_TIME}
ENV NODE_ENV=${NODE_ENV}
ENV HOSTNAME=${HOSTNAME}
ENV PORT=${PORT}
ENV SESSION_SECRET=${SESSION_SECRET}
ENV NEXTJS_ORIGIN=${NEXTJS_ORIGIN}
ENV NEXTJS_PORT=${NEXTJS_PORT}
# PSQL DATABSE CONFIG
ENV PG_SUPER_USER=${PG_SUPER_USER}
ENV PG_SUPER_PASSWORD=${PG_SUPER_PASSWORD}
ENV PG_ADMIN_USER=${PG_ADMIN_USER}
ENV PG_ADMIN_PASSWORD=${PG_ADMIN_PASSWORD}
ENV PG_HOST=${PG_HOST}
ENV PG_PORT=${PG_PORT}
ENV PG_SUPER_DATABASE=${PG_SUPER_DATABASE}
ENV PG_ADMIN_DATABASE=${PG_ADMIN_DATABASE}
# REDIS DATABASE CONFIG
ENV REDIS_HOST=${REDIS_HOST}
ENV REDIS_PORT=${REDIS_PORT}
# PAYMENTS
# Paypal
ENV PAYPAL_SECRET=${PAYPAL_SECRET}
# Paypal client_id for development mode
ENV PAYPAL_CLIENT_ID_SANDBOX=${PAYPAL_CLIENT_ID_SANDBOX}
# Paypal client_id for production mode
ENV PAYPAL_CLIENT_ID_PRODUCTION=${PAYPAL_CLIENT_ID_PRODUCTION}
# Stripe
ENV STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}

COPY . /api-server
WORKDIR /api-server
RUN npm install
#CMD ["npm", "run", "start"]
CMD chmod u+x scriptForDocker.sh && sh ./scriptForDocker.sh ${START_FIRST_TIME} ${NODE_ENV}
